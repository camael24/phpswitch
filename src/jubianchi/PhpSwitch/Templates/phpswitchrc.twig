#!/bin/bash

[ -z "$_PHPSWITCH_ORIG_PATH" ] && export _PHPSWITCH_ORIG_PATH=$PATH

php() {
    local VERSION STATUS

    STATUS=1

    case "$1" in
        -h)
            /usr/bin/env php -h
            STATUS=$?

            echo 'phpswitch commands:'
            echo '  - php list       Lists available PHP versions'
            echo '  - php current    Displays current PHP version'
            echo '  - php config     Gets or Sets configuration for current PHP version'
            echo '  - php switch     Switches current PHP version'

            return $STATUS
            ;;
        list)
            /usr/bin/env php -ddisplay_errors=stderr {{ path }}/bin/phpswitch php:list --installed 2> /dev/null

            return $?
            ;;

        current)
            /usr/bin/env php -ddisplay_errors=stderr {{ path }}/bin/phpswitch php:current 2> /dev/null

            /usr/bin/env php -ddisplay_errors=stderr -v 2> /dev/null

            return $?
            ;;

        config)
            /usr/bin/env php -ddisplay_errors=stderr {{ path }}/bin/phpswitch php:config $2 $3 2> /dev/null

            return $?
            ;;

        switch)
            if [ "$2" = "off" ]
            then
                export PATH=$_PHPSWITCH_ORIG_PATH
                /usr/bin/env php -ddisplay_errors=stderr {{ path }}/bin/phpswitch php:switch off 2> /dev/null
                STATUS=$?
            else
                if [ "$2" != "on" ]
                then
                    /usr/bin/env php -ddisplay_errors=stderr {{ path }}/bin/phpswitch php:switch $2 $3 2> /dev/null
                    STATUS=$?
                fi

                VERSION=$(/usr/bin/env php -ddisplay_errors=stderr {{ path }}/bin/phpswitch php:current 2> /dev/null)

                if [ $? ] && [ ! -z "$VERSION" ]
                then
                    export PATH={{ installed }}/$VERSION/bin:$_PHPSWITCH_ORIG_PATH
                fi
            fi

            [ $STATUS -eq 0 ] && /usr/bin/env php -ddisplay_errors=stderr -v 2> /dev/null

            return $?
            ;;
    esac

    /usr/bin/env php $*
}
